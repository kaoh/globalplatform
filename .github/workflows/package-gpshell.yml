name: package gpshell
on:
  workflow_dispatch:
  push:
    tags:
      - '**'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake make gcc g++ pkg-config \
            libpcsclite-dev libssl-dev zlib1g-dev \
            pandoc rpm dpkg-dev \
            libfuse2 curl patchelf
      - name: Prepare AppImage tooling
        run: |
          curl -L -o linuxdeploy \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
      - name: Build dynamic packages
        run: |
          cmake -S . -B build-dynamic -DCMAKE_BUILD_TYPE=Release
          cmake --build build-dynamic -- -j"$(nproc)"
          (cd build-dynamic && cpack -G DEB && cpack -G RPM)
          for f in build-dynamic/gpshell-*; do
            [ -f "$f" ] || continue
            case "$f" in
              *.deb|*.rpm)
                base="${f%.*}"
                ext="${f##*.}"
                mv "$f" "${base}-dynamic.${ext}"
                ;;
            esac
          done
      - name: Build static packages
        run: |
          cmake -S . -B build-static -DCMAKE_BUILD_TYPE=Release -DSTATIC=ON
          cmake --build build-static -- -j"$(nproc)"
          (cd build-static && cpack -G DEB && cpack -G RPM)
          for f in build-static/gpshell-*; do
            [ -f "$f" ] || continue
            case "$f" in
              *.deb|*.rpm)
                base="${f%.*}"
                ext="${f##*.}"
                mv "$f" "${base}-static.${ext}"
                ;;
            esac
          done
          rm -f ./*.AppImage
          cat > gpshell.desktop <<'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=GPShell
          Exec=gpshell3
          Icon=gpshell
          Terminal=true
          Categories=Utility;
          DESKTOP
          test -f gpshell.png
          export APPIMAGE_EXTRACT_AND_RUN=1
          rm -rf AppDir
          mkdir -p AppDir/usr/bin
          if [ -x build-static/gpshell/src/gpshell3 ]; then
            install -m 0755 build-static/gpshell/src/gpshell3 AppDir/usr/bin/gpshell3
          else
            install -m 0755 build-static/gpshell/src/gpshell3Static AppDir/usr/bin/gpshell3
          fi
          ./linuxdeploy \
            --appdir AppDir \
            -e AppDir/usr/bin/gpshell3 \
            -d gpshell.desktop \
            -i gpshell.png \
            --output appimage
          out=$(ls ./*.AppImage | head -n1)
          ver_current=$(awk '/_CURRENT/ {print $3}' gpshell/CMakeLists.txt | head -n1)
          ver_revision=$(awk '/_REVISION/ {print $3}' gpshell/CMakeLists.txt | head -n1)
          ver_age=$(awk '/_AGE/ {print $3}' gpshell/CMakeLists.txt | head -n1)
          version="${ver_current}.${ver_revision}.${ver_age}"
          if [ -z "$version" ]; then
            echo "Failed to determine version for AppImage name"
            exit 1
          fi
          mv "$out" "gpshell3-${version}.AppImage"
      - name: Sanity test artifacts
        run: |
          set -euo pipefail
          deb_dynamic=$(ls build-dynamic/gpshell-*-dynamic.deb | head -n1)
          deb_static=$(ls build-static/gpshell-*-static.deb | head -n1)
          rpm_dynamic=$(ls build-dynamic/gpshell-*-dynamic.rpm | head -n1)
          rpm_static=$(ls build-static/gpshell-*-static.rpm | head -n1)
          appimage=$(ls gpshell3-*.AppImage | head -n1)

          deb_pkg=$(dpkg-deb -f "$deb_dynamic" Package)
          sudo dpkg -i "$deb_dynamic"
          gpshell3 --help
          sudo dpkg -P "$deb_pkg"

          deb_pkg=$(dpkg-deb -f "$deb_static" Package)
          sudo dpkg -i "$deb_static"
          gpshell3 --help
          sudo dpkg -P "$deb_pkg"

          docker run --rm -v "$PWD:/work" -w /work fedora:39 bash -lc \
            "dnf -y install /work/$rpm_dynamic && gpshell3 --help"
          docker run --rm -v "$PWD:/work" -w /work fedora:39 bash -lc \
            "dnf -y install /work/$rpm_static && gpshell3 --help"

          chmod +x "$appimage"
          APPIMAGE_EXTRACT_AND_RUN=1 "./$appimage" --help
      - name: Save Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpshell-linux
          path: |
            build-dynamic/*.deb
            build-dynamic/*.rpm
            build-static/*.deb
            build-static/*.rpm
            gpshell3-*.AppImage

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Download OpenSSL
        run: |
          $client = new-object System.Net.WebClient
          $client.DownloadFile("https://slproweb.com/download/Win32OpenSSL-3_6_1.msi","C:\Temp\Win32OpenSSL-3_6_1.msi")
      - name: Install dependencies
        shell: cmd
        run: |
          choco install -y doxygen.install graphviz wixtoolset ninja
          C:\Temp\Win32OpenSSL-3_6_1.msi /quiet
          copy "C:\Program Files (x86)\OpenSSL-Win32\lib\VC\x86\MD\*" "C:\Program Files (x86)\OpenSSL-Win32\lib\VC"
      - name: Build dynamic packages
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          if exist build-dynamic rmdir /S /Q build-dynamic
          cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -B build-dynamic -DOPENSSL_ROOT_DIR="C:\Program Files (x86)\OpenSSL-Win32" -DZLIB_ROOT="%cd%\zlib-1.2.8\win32-build"
          cmake --build build-dynamic -- -v
          cmake --build build-dynamic --target doc -- -v
          cd build-dynamic
          cpack -G ZIP
          cpack -G WIX
          ..\windows-bundle.bat
      - name: Rename dynamic packages
        shell: pwsh
        run: |
          Get-ChildItem build-dynamic -File | Where-Object { $_.Name -like "gpshell-*.*" -and $_.Extension } | ForEach-Object {
            $base = $_.FullName.Substring(0, $_.FullName.Length - $_.Extension.Length)
            $ext = $_.Extension.TrimStart('.')
            Rename-Item $_.FullName "$base-dynamic.$ext"
          }
          Get-ChildItem build-dynamic\gpshell-bundle -File | Where-Object { $_.Name -like "gpshell-*.zip" -and $_.Extension } | ForEach-Object {
            $base = $_.FullName.Substring(0, $_.FullName.Length - $_.Extension.Length)
            Rename-Item $_.FullName "$base-dynamic.zip"
          }
      - name: Build static packages
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          if exist build-static rmdir /S /Q build-static
          cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -B build-static -DSTATIC=ON -DOPENSSL_ROOT_DIR="C:\Program Files (x86)\OpenSSL-Win32" -DZLIB_ROOT="%cd%\zlib-1.2.8\win32-build"
          cmake --build build-static -- -v
          cmake --build build-static --target doc -- -v
          cd build-static
          cpack -G ZIP
          cpack -G WIX
      - name: Rename static packages
        shell: pwsh
        run: |
          Get-ChildItem build-static -File | Where-Object { $_.Name -like "gpshell-*.*" -and $_.Extension } | ForEach-Object {
            $base = $_.FullName.Substring(0, $_.FullName.Length - $_.Extension.Length)
            $ext = $_.Extension.TrimStart('.')
            Rename-Item $_.FullName "$base-static.$ext"
          }
      - name: Sanity test artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $msi = Get-ChildItem build-static -Filter "gpshell-*-static.msi" | Select-Object -First 1
          if (-not $msi) { throw "Static MSI not found" }
          Start-Process msiexec -ArgumentList "/i `"$($msi.FullName)`" /qn /norestart" -Wait -NoNewWindow

          $exe = $null
          $roots = @($Env:ProgramFiles, ${Env:ProgramFiles(x86)})
          foreach ($root in $roots) {
            if (-not $root) { continue }
            $dirs = Get-ChildItem $root -Directory -Filter "gpshell*" -ErrorAction SilentlyContinue
            foreach ($dir in $dirs) {
              $candidate = Join-Path $dir.FullName "bin\gpshell3.exe"
              if (Test-Path $candidate) { $exe = $candidate; break }
              $candidate = Join-Path $dir.FullName "gpshell3.exe"
              if (Test-Path $candidate) { $exe = $candidate; break }
            }
            if ($exe) { break }
          }
          if (-not $exe) { throw "gpshell3.exe not found after MSI install" }
          & $exe --help

          $zip = Get-ChildItem build-static -Filter "gpshell-*-static.zip" | Select-Object -First 1
          if (-not $zip) { throw "Static ZIP not found" }
          $zipDir = Join-Path $env:TEMP "gpshell-static-zip"
          if (Test-Path $zipDir) { Remove-Item -Recurse -Force $zipDir }
          Expand-Archive -Path $zip.FullName -DestinationPath $zipDir -Force
          $zipExe = Get-ChildItem $zipDir -Recurse -Filter "gpshell3.exe" | Select-Object -First 1
          if (-not $zipExe) { throw "gpshell3.exe not found in static ZIP" }
          & $zipExe.FullName --help

          $bundle = Get-ChildItem build-dynamic\gpshell-bundle -Filter "gpshell-*-dynamic.zip" | Select-Object -First 1
          if (-not $bundle) { throw "Bundle ZIP not found" }
          $bundleDir = Join-Path $env:TEMP "gpshell-bundle"
          if (Test-Path $bundleDir) { Remove-Item -Recurse -Force $bundleDir }
          Expand-Archive -Path $bundle.FullName -DestinationPath $bundleDir -Force
          $bundleExe = Get-ChildItem $bundleDir -Recurse -Filter "gpshell3.exe" | Select-Object -First 1
          if (-not $bundleExe) { throw "gpshell3.exe not found in bundle ZIP" }
          & $bundleExe.FullName --help
      - name: Save Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpshell-windows
          path: |
            build-dynamic/*.zip
            build-dynamic/*.msi
            build-dynamic/gpshell-bundle/*.zip
            build-static/*.zip
            build-static/*.msi

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config openssl@3 pandoc
      - name: Build dynamic packages
        run: |
          OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake -S . -B build-dynamic -DCMAKE_BUILD_TYPE=Release -DOPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR}"
          cmake --build build-dynamic -- -j"$(sysctl -n hw.ncpu)"
          (cd build-dynamic && cpack -G DragNDrop)
          for f in build-dynamic/gpshell-*.dmg; do
            [ -f "$f" ] || continue
            base="${f%.*}"
            mv "$f" "${base}-dynamic.dmg"
          done
      - name: Build static packages
        run: |
          OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake -S . -B build-static -DCMAKE_BUILD_TYPE=Release -DSTATIC=ON -DOPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR}"
          cmake --build build-static -- -j"$(sysctl -n hw.ncpu)"
          (cd build-static && cpack -G DragNDrop)
          for f in build-static/gpshell-*.dmg; do
            [ -f "$f" ] || continue
            base="${f%.*}"
            mv "$f" "${base}-static.dmg"
          done
      - name: Sanity test artifacts
        run: |
          set -euo pipefail
          for dmg in build-static/gpshell-*-static.dmg build-dynamic/gpshell-*-dynamic.dmg; do
            [ -f "$dmg" ] || { echo "Missing dmg: $dmg"; exit 1; }
            mnt=""
            attach_out=$(hdiutil attach -nobrowse -readonly -noautoopen -noverify -mountpoint "/tmp/gpshell-mount.$$" "$dmg" 2>&1) || true
            if echo "$attach_out" | grep -q "/Volumes/"; then
              mnt=$(echo "$attach_out" | awk '/\\/Volumes\\// {print $3; exit}')
            elif [ -d "/tmp/gpshell-mount.$$" ]; then
              mnt="/tmp/gpshell-mount.$$"
            fi
            if [ -z "$mnt" ]; then
              attach_out=$(hdiutil attach -nobrowse -readonly -noautoopen -noverify "$dmg" 2>&1) || true
              mnt=$(echo "$attach_out" | awk '/\\/Volumes\\// {print $3; exit}')
            fi
            if [ -z "$mnt" ]; then
              echo "Failed to find mount point for $dmg"
              echo "$attach_out"
              exit 1
            fi
            exe=$(find "$mnt" -type f -name gpshell3 | head -n1)
            if [ -z "$exe" ]; then
              hdiutil detach "$mnt" >/dev/null
              echo "gpshell3 not found in $dmg"
              exit 1
            fi
            "$exe" --help
            hdiutil detach "$mnt" >/dev/null
          done
      - name: Save macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpshell-macos
          path: |
            build-dynamic/*.dmg
            build-static/*.dmg
