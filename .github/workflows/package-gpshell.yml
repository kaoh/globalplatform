name: package gpshell
on:
  workflow_dispatch:
  push:
    tags:
      - '**'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake make gcc g++ pkg-config \
            libpcsclite-dev libssl-dev zlib1g-dev \
            pandoc rpm dpkg-dev \
            libfuse2 curl patchelf
      - name: Prepare AppImage tooling
        run: |
          curl -L -o linuxdeploy \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
      - name: Build dynamic packages
        run: |
          cmake -S . -B build-dynamic -DCMAKE_BUILD_TYPE=Release
          cmake --build build-dynamic -- -j"$(nproc)"
          (cd build-dynamic && cpack -G DEB && cpack -G RPM)
          for f in build-dynamic/gpshell-binary-*; do
            [ -f "$f" ] || continue
            case "$f" in
              *.deb|*.rpm)
                base="${f%.*}"
                ext="${f##*.}"
                mv "$f" "${base}-dynamic.${ext}"
                ;;
            esac
          done
      - name: Build static packages
        run: |
          cmake -S . -B build-static -DCMAKE_BUILD_TYPE=Release -DSTATIC=ON
          cmake --build build-static -- -j"$(nproc)"
          (cd build-static && cpack -G DEB && cpack -G RPM)
          for f in build-static/gpshell-binary-*; do
            [ -f "$f" ] || continue
            case "$f" in
              *.deb|*.rpm)
                base="${f%.*}"
                ext="${f##*.}"
                mv "$f" "${base}-static.${ext}"
                ;;
            esac
          done
          rm -f ./*.AppImage
          cat > gpshell.desktop <<'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=GPShell
          Exec=gpshell3
          Icon=gpshell
          Terminal=true
          Categories=Utility;
          DESKTOP
          test -f gpshell.png
          export APPIMAGE_EXTRACT_AND_RUN=1
          rm -rf AppDir
          mkdir -p AppDir/usr/bin
          install -m 0755 build-static/gpshell/src/gpshell3Static AppDir/usr/bin/gpshell3
          ./linuxdeploy \
            --appdir AppDir \
            -e AppDir/usr/bin/gpshell3 \
            -d gpshell.desktop \
            -i gpshell.png \
            --output appimage
          base=$(ls build-static/gpshell-binary-*-static.deb | head -n1 | sed 's/-static\.deb$//')
          out=$(ls ./*.AppImage | head -n1)
          mv "$out" "${base}-static.AppImage"
      - name: Save Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpshell-linux
          path: |
            build-dynamic/*.deb
            build-dynamic/*.rpm
            build-static/*.deb
            build-static/*.rpm
            build-static/*.AppImage

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Download OpenSSL
        run: |
          $client = new-object System.Net.WebClient
          $client.DownloadFile("https://slproweb.com/download/Win32OpenSSL-3_6_1.msi","C:\Temp\Win32OpenSSL-3_6_1.msi")
      - name: Install dependencies
        shell: cmd
        run: |
          choco install -y doxygen.install graphviz wixtoolset
          C:\Temp\Win32OpenSSL-3_6_1.msi /quiet
          copy "C:\Program Files (x86)\OpenSSL-Win32\lib\VC\x86\MD\*" "C:\Program Files (x86)\OpenSSL-Win32\lib\VC"
      - name: Build dynamic packages
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          cmake -G "NMake Makefiles" -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -B build-dynamic -DOPENSSL_ROOT_DIR="C:\Program Files (x86)\OpenSSL-Win32" -DZLIB_ROOT="%cd%\zlib-1.2.8\win32-build"
          cd build-dynamic
          nmake VERBOSE=1
          nmake VERBOSE=1 doc
          cpack -G ZIP
          cpack -G WIX
          ..\windows-bundle.bat
      - name: Rename dynamic packages
        shell: pwsh
        run: |
          Get-ChildItem build-dynamic -Filter "gpshell-binary-*.*" | ForEach-Object {
            $base = $_.FullName.Substring(0, $_.FullName.LastIndexOf('.'))
            $ext = $_.Extension.TrimStart('.')
            Rename-Item $_.FullName "$base-dynamic.$ext"
          }
          Get-ChildItem build-dynamic\gpshell-bundle -Filter "gpshell-binary-*.zip" | ForEach-Object {
            $base = $_.FullName.Substring(0, $_.FullName.LastIndexOf('.'))
            Rename-Item $_.FullName "$base-dynamic.zip"
          }
      - name: Build static packages
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          cmake -G "NMake Makefiles" -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -B build-static -DSTATIC=ON -DOPENSSL_ROOT_DIR="C:\Program Files (x86)\OpenSSL-Win32" -DZLIB_ROOT="%cd%\zlib-1.2.8\win32-build"
          cd build-static
          nmake VERBOSE=1
          nmake VERBOSE=1 doc
          cpack -G ZIP
          cpack -G WIX
      - name: Rename static packages
        shell: pwsh
        run: |
          Get-ChildItem build-static -Filter "gpshell-binary-*.*" | ForEach-Object {
            $base = $_.FullName.Substring(0, $_.FullName.LastIndexOf('.'))
            $ext = $_.Extension.TrimStart('.')
            Rename-Item $_.FullName "$base-static.$ext"
          }
      - name: Save Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpshell-windows
          path: |
            build-dynamic/*.zip
            build-dynamic/*.msi
            build-dynamic/gpshell-bundle/*.zip
            build-static/*.zip
            build-static/*.msi

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config openssl@3 pandoc
      - name: Build dynamic packages
        run: |
          OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake -S . -B build-dynamic -DCMAKE_BUILD_TYPE=Release -DOPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR}"
          cmake --build build-dynamic -- -j"$(sysctl -n hw.ncpu)"
          (cd build-dynamic && cpack -G DragNDrop)
          for f in build-dynamic/gpshell-binary-*.dmg; do
            [ -f "$f" ] || continue
            base="${f%.*}"
            mv "$f" "${base}-dynamic.dmg"
          done
      - name: Build static packages
        run: |
          OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake -S . -B build-static -DCMAKE_BUILD_TYPE=Release -DSTATIC=ON -DOPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR}"
          cmake --build build-static -- -j"$(sysctl -n hw.ncpu)"
          (cd build-static && cpack -G DragNDrop)
          for f in build-static/gpshell-binary-*.dmg; do
            [ -f "$f" ] || continue
            base="${f%.*}"
            mv "$f" "${base}-static.dmg"
          done
      - name: Save macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpshell-macos
          path: |
            build-dynamic/*.dmg
            build-static/*.dmg
